<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Learning Experiences" href="../learning/index.html" /><link rel="prev" title="An Alternative 2D Loop on the GPU" href="loops.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Lucas-Kanade Optical Flow on the GPU - A Shaderboy&#39;s Collection</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=acfd86a5" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">A Shaderboy's Collection</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">A Shaderboy's Collection</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Graphics Programming Blog</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Graphics Programming Blog</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">GPU Media Processing</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of GPU Media Processing</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="autoexposure.html">Hardware Auto Exposure on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="bilateral.html">Multi-Level Bilateral Upsampling on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="censustransform.html">Census Transform on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="chromaticity.html">Image Chromaticity on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="edges.html">Bilinear Edge Detection on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="gaussianblur.html">Bilinear Gaussian Blur on the GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="loops.html">An Alternative 2D Loop on the GPU</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Lucas-Kanade Optical Flow on the GPU</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../learning/index.html">Learning Experiences</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Learning Experiences</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../learning/coordinatespaces.html">A Refresher on Coordinate Spaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../learning/cpp.html">GiraffeAcademy’s C++ Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../learning/pythonengine.html">A Pythonic 3D Engine in 1 Weekend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../learning/reshadefx.html">ReShadeFX for Beginners</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pr/index.html">Project Reality Development</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Project Reality Development</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pr/logdepth.html">Logarithmic Depth Buffering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pr/shadermodel3.html">What I Learned Porting to Shader Model 3.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../social/index.html">Content Creation Guide</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Content Creation Guide</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../social/project.html">Project PAPADANKU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../social/instagram.html">Instagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../social/youtube.html">YouTube</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../../_sources/source/blog/gpu/opticalflow.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="lucas-kanade-optical-flow-on-the-gpu">
<h1>Lucas-Kanade Optical Flow on the GPU<a class="headerlink" href="#lucas-kanade-optical-flow-on-the-gpu" title="Link to this heading">¶</a></h1>
<p>An optical flow algorithm estimates motion between consecutive video frames. Optical flow is crucial in object detection, object recognition, motion estimation, video compression, and video effects.</p>
<p>This post covers an HLSL implementation of the Lucas-Kanade optical flow algorithm.</p>
<section id="the-brightness-constancy-assumption">
<h2>The Brightness Constancy Assumption<a class="headerlink" href="#the-brightness-constancy-assumption" title="Link to this heading">¶</a></h2>
<p>When we use our eyes to track an object, we make assumptions to determine if an object has moved. For example, we can infer that a red dot has moved if we observe it maintaining its red color but appearing in a different location than it did a moment ago.</p>
<p>Accurate motion estimation in video relies on fundamental assumptions:</p>
<ol class="arabic simple">
<li><p>The intensity (brightness and color) of an object’s movement in two consecutive images remains <em>approximately constant</em>.</p></li>
<li><p>The movement of objects between two images is <em>small</em>.</p></li>
</ol>
<p>These assumptions form the basis of the <strong>Brightness Constancy Assumption</strong>.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[I(x, y, t) = I(x + u, y + v, t + 1)\]</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>The Brightness Constancy Assumption has a limitation:</strong> This assumption holds best for objects whose appearance does not significantly change between frames. For instance, it would struggle with a ball that constantly changes color or an object moving into shadow or direct light.</p>
</div>
</section>
<section id="the-optical-flow-equation">
<h2>The Optical Flow Equation<a class="headerlink" href="#the-optical-flow-equation" title="Link to this heading">¶</a></h2>
<p>Let’s revisit the Brightness Constancy Assumption:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[I(x, y, t) = I(x + u, y + v, t + 1)\]</div>
</div>
<p>From this direct equality, it’s not obvious how to create a formula for optical flow, as it states that the intensity at a point <span class="math notranslate nohighlight">\((x, y)\)</span> in the previous image <span class="math notranslate nohighlight">\(I\)</span> at time <span class="math notranslate nohighlight">\(t\)</span> is equal to the intensity of the <em>same point</em> at a new position <span class="math notranslate nohighlight">\((x + u, y + v)\)</span> in the current image at time <span class="math notranslate nohighlight">\(t + 1\)</span>. Our goal is to find <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>.</p>
<p>To achieve this, we need a mathematical way to approximate the rate of change of image intensity from <span class="math notranslate nohighlight">\(I(x, y, t)\)</span> to <span class="math notranslate nohighlight">\(I(x + u, y + v, t + 1)\)</span>. This is where derivatives and the Taylor series expansion become crucial.</p>
<p>We apply a first-order Taylor series expansion to the right-hand side of the Brightness Constancy Assumption, around the point <span class="math notranslate nohighlight">\((x, y, t)\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[I(x + u, y + v, t + 1) \approx I(x, y, t) + \frac{ \partial I }{ \partial x} u + \frac{\partial I}{\partial y} v + \frac{\partial I}{\partial t}\]</div>
</div>
<p>Substituting this approximation back into the Brightness Constancy Assumption and simplifying:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}I(x, y, t) \approx I(x, y, t) + \frac{ \partial I }{ \partial x} u + \frac{\partial I}{\partial y} v + \frac{\partial I}{\partial t}\\
0 \approx \frac{ \partial I }{ \partial x} u + \frac{\partial I}{\partial y} v + \frac{\partial I}{\partial t}\end{split}\]</div>
</div>
<p>This is the <strong>Optical Flow Equation</strong>. Rearranging it to isolate the temporal change:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\frac{ \partial I }{ \partial x} u + \frac{\partial I}{\partial y} v \approx -\frac{\partial I}{\partial t}\]</div>
</div>
<p>This is the spatial gradient (how brightness changes horizontally and vertically):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\frac{\partial I}{\partial x}, \frac{\partial I}{\partial y}\]</div>
</div>
<p>This is the temporal gradient (how brightness changes over time at a fixed location):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\frac{\partial I}{\partial t}\]</div>
</div>
<p>Our objective is to solve for <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>, the horizontal and vertical components of the optical flow vector.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use a first-order Taylor series expansion because the “small movement” assumption means that the changes regarding <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span> are small. This allows us to ignore higher-order terms in the expansion, which simplifies the math significantly while still providing a good approximation.</p>
</div>
</section>
<section id="the-aperture-problem-in-practice">
<h2>The Aperture Problem - In Practice<a class="headerlink" href="#the-aperture-problem-in-practice" title="Link to this heading">¶</a></h2>
<p>Here’s a practical demonstration of the Aperture Problem.</p>
<ol class="arabic simple">
<li><p>Get a string long enough that you cannot see its ends when viewing it through a small, fixed opening (an “aperture”).</p></li>
<li><p>Position the string behind the opening.</p></li>
<li><p>Angle the string at 45-degrees.</p></li>
<li><p>Now, slide the string through the opening in the following ways, ensuring its ends remain outside your view through the hole:</p>
<ul class="simple">
<li><p><strong>Horizontally</strong> slide the string across the opening.</p></li>
<li><p><strong>Vertically</strong> slide the string across the opening.</p></li>
<li><p><strong>Diagonally</strong> slide the string across the opening.</p></li>
</ul>
</li>
</ol>
<p>Did you see a difference in motion when sliding the string horizontally, vertically, or diagonally? Probably not, unless you can see the entire string within the opening.</p>
<p><strong>The Problem:</strong> Your limited perception through the small aperture causes you to observe the string appearing to “move the same way” (only perpendicular to its orientation), regardless of its actual global movement direction. You cannot disambiguate its true 2D motion.</p>
<p>Let’s examine the mathematical version of this problem.</p>
</section>
<section id="the-aperture-problem-in-mathematics">
<h2>The Aperture Problem - In Mathematics<a class="headerlink" href="#the-aperture-problem-in-mathematics" title="Link to this heading">¶</a></h2>
<p>Consider the Optical Flow Equation:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\frac{ \partial I }{ \partial x} u + \frac{\partial I}{\partial y} v \approx -\frac{\partial I}{\partial t}\]</div>
</div>
<p>Imagine you’re back in your underfunded school’s math class, and your teacher asks the class to solve the following single linear equation for unknowns <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[3u + 4v = 0\]</div>
</div>
<p>Possible solutions the class might propose include:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}u = -4, v = 3 \\
u = 4, v = -3 \\
u = 0, v = 0\end{split}\]</div>
</div>
<p>This demonstrates that for a single pixel (which acts as a tiny aperture), the optical flow equation provides only one equation on two unknowns <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>. Consequently, there are infinitely many pairs of <span class="math notranslate nohighlight">\((u, v)\)</span> that satisfy the equation. If you plot these solutions on a graph, they all lie on a single line, meaning the true direction of motion is ambiguous - only the component of motion perpendicular to the image gradient can be determined.</p>
</section>
<section id="the-lucas-kanade-approach-to-the-aperture-problem">
<h2>The Lucas-Kanade Approach to The Aperture Problem<a class="headerlink" href="#the-lucas-kanade-approach-to-the-aperture-problem" title="Link to this heading">¶</a></h2>
<p>The Lucas-Kanade method is a <strong>local</strong> technique designed to overcome the aperture problem by solving a system of optical flow equations within a small spatial window or neighborhood.</p>
<p>To estimate the local image flow at a given point, the Lucas-Kanade method employs a least-squares approach. This method solves an overdetermined system of linear equations, where each pixel within the chosen window contributes an optical flow equation.</p>
<p>The standard Lucas-Kanade algorithm typically solves these systems of equations within a 3x3 window, as this size often provides a good balance, effectively considering motion components in various directions.</p>
<section id="least-squares-derivation">
<h3>Least-Squares Derivation<a class="headerlink" href="#least-squares-derivation" title="Link to this heading">¶</a></h3>
<p>This is the initial system of linear equations in the form <span class="math notranslate nohighlight">\(A \mathbf{x} = \mathbf{b}\)</span>.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
I_{x_{1}} &amp; I_{y_{1}} \\
I_{x_{2}} &amp; I_{y_{2}} \\
I_{x_{3}} &amp; I_{y_{3}}
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix} =
\begin{bmatrix}
-I_{t_{1}} \\
-I_{t_{2}} \\
-I_{t_{3}}
\end{bmatrix}\end{split}\]</div>
</div>
<p>To find the least-squares solution, we multiply both sides by the transpose of the matrix, <span class="math notranslate nohighlight">\(A^T\)</span>.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
I_{x_{1}} &amp; I_{x_{2}} &amp; I_{x_{3}} \\
I_{y_{1}} &amp; I_{y_{2}} &amp; I_{y_{3}}
\end{bmatrix}
\begin{bmatrix}
I_{x_{1}} &amp; I_{y_{1}} \\
I_{x_{2}} &amp; I_{y_{2}} \\
I_{x_{3}} &amp; I_{y_{3}}
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix} =
\begin{bmatrix}
I_{x_{1}} &amp; I_{x_{2}} &amp; I_{x_{3}} \\
I_{y_{1}} &amp; I_{y_{2}} &amp; I_{y_{3}}
\end{bmatrix}
\begin{bmatrix}
-I_{t_{1}} \\
-I_{t_{2}} \\
-I_{t_{3}}
\end{bmatrix}\end{split}\]</div>
</div>
<p>The result of the matrix multiplication is expressed in summation form.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
\sum I_{x_{i}}^{2} &amp; \sum I_{x_{i}}I_{y_{i}} \\
\sum I_{x_{i}}I_{y_{i}} &amp; \sum I_{y_{i}}^{2}
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix} =
\begin{bmatrix}
\sum -I_{t_{i}}I_{x_{i}} \\
\sum -I_{t_{i}}I_{y_{i}}
\end{bmatrix}\end{split}\]</div>
</div>
<p>We now multiply both sides by the inverse of the matrix on the left, <span class="math notranslate nohighlight">\((A^T A)^{-1}\)</span>, to isolate the <span class="math notranslate nohighlight">\(\begin{bmatrix} u \\ v \end{bmatrix}\)</span> vector.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
\sum I_{x_{i}}^{2} &amp; \sum I_{x_{i}}I_{y_{i}} \\
\sum I_{x_{i}}I_{y_{i}} &amp; \sum I_{y_{i}}^{2}
\end{bmatrix}^{-1}
\begin{bmatrix}
\sum I_{x_{i}}^{2} &amp; \sum I_{x_{i}}I_{y_{i}} \\
\sum I_{x_{i}}I_{y_{i}} &amp; \sum I_{y_{i}}^{2}
\end{bmatrix}
\begin{bmatrix}
u \\
v
\end{bmatrix} =
\begin{bmatrix}
\sum I_{x_{i}}^{2} &amp; \sum I_{x_{i}}I_{y_{i}} \\
\sum I_{x_{i}}I_{y_{i}} &amp; \sum I_{y_{i}}^{2}
\end{bmatrix}^{-1}
\begin{bmatrix}
\sum -I_{t_{i}}I_{x_{i}} \\
\sum -I_{t_{i}}I_{y_{i}}
\end{bmatrix}\end{split}\]</div>
</div>
<p>The final step is the solution for the vector <span class="math notranslate nohighlight">\(\begin{bmatrix} u \\ v \end{bmatrix}\)</span>.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
u \\
v
\end{bmatrix} =
\begin{bmatrix}
\sum I_{x_{i}}^{2} &amp; \sum I_{x_{i}}I_{y_{i}} \\
\sum I_{x_{i}}I_{y_{i}} &amp; \sum I_{y_{i}}^{2}
\end{bmatrix}^{-1}
\begin{bmatrix}
\sum -I_{t_{i}}I_{x_{i}} \\
\sum -I_{t_{i}}I_{y_{i}}
\end{bmatrix}\end{split}\]</div>
</div>
</section>
</section>
<section id="the-pyramid-approach">
<h2>The Pyramid Approach<a class="headerlink" href="#the-pyramid-approach" title="Link to this heading">¶</a></h2>
<p>The Lucas-Kanade method, while effective for small displacements, becomes less accurate for large motions. This is because large movements violate the “small movement” assumption inherent in the first-order Taylor expansion and the brightness constancy assumption. To handle larger motions while maintaining efficiency and adherence to assumptions, a hierarchical, or “pyramid,” approach is used:</p>
<p>This approach ensures:</p>
<ul class="simple">
<li><p>It does not break the <strong>brightness constancy</strong> assumption, as motion is incrementally estimated  at different scales.</p></li>
<li><p>It handles cases where the actual movement between two images is significant.</p></li>
<li><p>It facilitates fast computation by starting with coarse motion estimates at lower resolutions.</p></li>
<li><p>It covers motion in areas larger than a 3x3 window by propagating estimates across pyramid levels.</p></li>
</ul>
<p>The pyramid Lucas-Kanade algorithm consists of the following general steps:</p>
<ol class="arabic simple">
<li><p>Create an image pyramid for the current frame and previous frame.</p></li>
<li><p>Initialize the motion vector at the smallest pyramid level to <strong>0.0</strong> or a previous estimate.</p></li>
<li><p>Compute optical flow iteratively from the smallest pyramid level to the largest level. At each level, the flow from the smaller level is used to “warp” the image, reducing the remaining displacement, and then a refinement is calculated.</p></li>
<li><p>Cache the current frame (or its pyramid) for use as the “previous frame” in the next optical flow calculation.</p></li>
<li><p>Optionally, filter the computed optical flow vectors to remove noise or outliers.</p></li>
</ol>
</section>
<section id="source-code">
<h2>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code contains <strong>generic</strong> functions, so you may need to change some parts of the code so it is compatible with your setup.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Converting from 2D Grid Position to 1D Index</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-hlsl notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">   Function to convert 2D row and column (0-indexed) to a 1D index.</span>
<span class="cm">   ZeroIndexGridPos.x: The 0-indexed row number.</span>
<span class="cm">   ZeroIndexGridPos.y: The 0-indexed column number.</span>
<span class="cm">   GridWidth: The total width of the grid (number of columns).</span>
<span class="cm">   Returns a 1D index.</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="kt">int2</span><span class="w"> </span><span class="n">ZeroIndexGridPos</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">GridWidth</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">ZeroIndexGridPos</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">GridWidth</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ZeroIndexGridPos</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Converting to Spherical RGB</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-hlsl notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">   This code is based on the algorithm described in the following paper:</span>
<span class="cm">   Author(s): Joost van de Weijer, T. Gevers</span>
<span class="cm">   Title: &quot;Robust optical flow from photometric invariants&quot;</span>
<span class="cm">   Year: 2004</span>
<span class="cm">   DOI: 10.1109/ICIP.2004.1421433</span>

<span class="cm">   https://www.researchgate.net/publication/4138051_Robust_optical_flow_from_photometric_invariants</span>
<span class="cm">*/</span>

<span class="kt">float3</span><span class="w"> </span><span class="n">RGBtoSphericalRGB</span><span class="p">(</span><span class="kt">float3</span><span class="w"> </span><span class="n">RGB</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">InvPi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// Precalculate (x*x + y*y)^0.5 and (x*x + y*y + z*z)^0.5</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">RGB</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">L2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">RGB</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// .x = radius; .y = inclination; .z = azimuth</span>
<span class="w">   </span><span class="kt">float3</span><span class="w"> </span><span class="n">RIA</span><span class="p">;</span>
<span class="w">   </span><span class="n">RIA</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">);</span>
<span class="w">   </span><span class="n">RIA</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">L1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">saturate</span><span class="p">(</span><span class="n">RGB</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">L1</span><span class="p">);</span>
<span class="w">   </span><span class="n">RIA</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">L2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">saturate</span><span class="p">(</span><span class="n">RGB</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">L2</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// Scale the angles to [-1.0, 1.0) range</span>
<span class="w">   </span><span class="n">RIA</span><span class="p">.</span><span class="n">yz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RIA</span><span class="p">.</span><span class="n">yz</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Calculate inclination and azimuth and normalize to [0.0, 1.0)</span>
<span class="w">   </span><span class="n">RIA</span><span class="p">.</span><span class="n">yz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="n">RIA</span><span class="p">.</span><span class="n">yz</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">InvPi</span><span class="p">;</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">RIA</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Lucas-Kanade Optical Flow</span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-hlsl notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">   Lucas-Kanade optical flow with bilinear fetches. The algorithm is motified to not output in pixels, but normalized displacements.</span>

<span class="cm">   ---</span>

<span class="cm">   Gauss-Newton Steepest Descent Inverse Additive Algorithm</span>

<span class="cm">   Baker, S., &amp; Matthews, I. (2004). Lucas-kanade 20 years on: A unifying framework. International journal of computer vision, 56, 221-255.</span>

<span class="cm">   https://www.researchgate.net/publication/248602429_Lucas-Kanade_20_Years_On_A_Unifying_Framework_Part_1_The_Quantity_Approximated_the_Warp_Update_Rule_and_the_Gradient_Descent_Approximation</span>

<span class="cm">   ---</span>

<span class="cm">   Application of Lucas-Kanade algorithm with weight coefficient bilateral filtration for the digital image correlation method</span>

<span class="cm">   Titkov, V. V., Panin, S. V., Lyubutin, P. S., Chemezov, V. O., &amp; Eremin, A. V. (2017). Application of Lucas-Kanade algorithm with weight coefficient bilateral filtration for the digital image correlation method. IOP Conference Series: Materials Science and Engineering, 177, 012039. https://doi.org/10.1088/1757-899X/177/1/012039</span>
<span class="cm">*/</span>

<span class="kt">float2</span><span class="w"> </span><span class="n">GetLucasKanade</span><span class="p">(</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsCoarse</span><span class="p">,</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">MainTex</span><span class="p">,</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">Vectors</span><span class="p">,</span>
<span class="w">   </span><span class="n">sampler2D</span><span class="w"> </span><span class="n">SampleT</span><span class="p">,</span>
<span class="w">   </span><span class="n">sampler2D</span><span class="w"> </span><span class="n">SampleI</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">// Initialize variables</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">IxIx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">IyIy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">IxIy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">IxIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">IyIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">SumW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Calculate warped texture coordinates</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">WarpTex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MainTex</span><span class="p">;</span>
<span class="w">   </span><span class="n">WarpTex</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"> </span><span class="c1">// Pull into [-0.5, 0.5) range</span>
<span class="w">   </span><span class="n">WarpTex</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">Vectors</span><span class="p">;</span><span class="w"> </span><span class="c1">// Inverse warp in the [-0.5, 0.5) range</span>
<span class="w">   </span><span class="n">WarpTex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">saturate</span><span class="p">(</span><span class="n">WarpTex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Push and clamp into [0.0, 1.0) range</span>

<span class="w">   </span><span class="c1">// Get gradient information</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">PixelSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">fwidth</span><span class="p">(</span><span class="n">MainTex</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/*</span>
<span class="cm">      * = Indecies for calculating the temporal gradient (IT)</span>
<span class="cm">      - = Unused indecies</span>

<span class="cm">      Template indecies:</span>

<span class="cm">         00- 01  02  03  04-</span>
<span class="cm">         05  06* 07* 08* 09</span>
<span class="cm">         10  11* 12* 13* 14</span>
<span class="cm">         15  16* 17* 18* 19</span>
<span class="cm">         20- 21  22  23  24-</span>

<span class="cm">      Template (Row, Column):</span>

<span class="cm">         (4, 0) (4, 1) (4, 2) (4, 3) (4, 4)</span>
<span class="cm">         (3, 0) (3, 1) (3, 2) (3, 3) (3, 4)</span>
<span class="cm">         (2, 0) (2, 1) (2, 2) (2, 3) (2, 4)</span>
<span class="cm">         (1, 0) (1, 1) (1, 2) (1, 3) (1, 4)</span>
<span class="cm">         (0, 0) (0, 1) (0, 2) (0, 3) (0, 4)</span>
<span class="cm">   */</span>

<span class="w">   </span><span class="c1">// Initiate TemplateCache</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TemplateCacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float3</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">TemplateCacheSize</span><span class="p">];</span>

<span class="w">   </span><span class="c1">// Create TemplateCache</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">TemplateCacheIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">[</span><span class="nd">unroll</span><span class="p">]</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">y1</span><span class="o">--</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="p">[</span><span class="nd">unroll</span><span class="p">]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">x1</span><span class="o">++</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="p">[</span><span class="nd">flatten</span><span class="p">]</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="n">TemplateCacheIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">else</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float2</span><span class="w"> </span><span class="n">Tex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MainTex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PixelSize</span><span class="p">);</span>
<span class="w">            </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">TemplateCacheIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tex2D</span><span class="p">(</span><span class="n">SampleT</span><span class="p">,</span><span class="w"> </span><span class="n">Tex</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="w">            </span><span class="n">TemplateCacheIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// Loop over the starred template areas</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">FetchGridWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">FetchGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchGridWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FetchGridWidth</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// .xy = TemplateGridPos; .zw = FetchPos</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int4</span><span class="w"> </span><span class="n">P</span><span class="p">[</span><span class="n">FetchGridSize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span>
<span class="w">      </span><span class="kt">int4</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">   </span><span class="p">};</span>

<span class="w">   </span><span class="c1">// Get center textures (this is for the spatial weighting)</span>
<span class="w">   </span><span class="kt">float3</span><span class="w"> </span><span class="n">CenterT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="kt">int2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>
<span class="w">   </span><span class="kt">float3</span><span class="w"> </span><span class="n">CenterI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tex2D</span><span class="p">(</span><span class="n">SampleI</span><span class="p">,</span><span class="w"> </span><span class="n">WarpTex</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>

<span class="w">   </span><span class="p">[</span><span class="nd">unroll</span><span class="p">]</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">FetchGridSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">Cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mo">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mo">0</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Calculate temporal gradient</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">R0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cached</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">CenterT</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zw</span><span class="p">,</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cached</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">CenterI</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">tex2D</span><span class="p">(</span><span class="n">SampleI</span><span class="p">,</span><span class="w"> </span><span class="n">WarpTex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xy</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PixelSize</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">R0</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Calculate weight</span>
<span class="w">      </span><span class="n">R0</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">CenterT</span><span class="p">;</span>
<span class="w">      </span><span class="n">R1</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">CenterI</span><span class="p">;</span>
<span class="w">      </span><span class="n">R0</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dot</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="n">R0</span><span class="p">);</span>
<span class="w">      </span><span class="n">R0</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dot</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">);</span>
<span class="w">      </span><span class="n">R0</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">Weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rsqrt</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">));</span>
<span class="w">      </span><span class="n">Weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">smoothstep</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>
<span class="w">      </span><span class="n">Weight</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">Weight</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Calculate spatial and temporal gradients</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">North</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">South</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mo">0</span><span class="p">),</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">East</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>
<span class="w">      </span><span class="kt">float3</span><span class="w"> </span><span class="n">West</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateCache</span><span class="p">[</span><span class="n">Get1DIndexFrom2D</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">zw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">int2</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">TemplateGridSize</span><span class="p">)];</span>

<span class="w">      </span><span class="c1">// IxIx = A11; IxIt = B1</span>
<span class="w">      </span><span class="n">R0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">West</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">East</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">      </span><span class="n">IxIx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="n">R0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>
<span class="w">      </span><span class="n">IxIt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="n">It</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// IyIy = A22; IyIt = B2</span>
<span class="w">      </span><span class="n">R1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">North</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">South</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">      </span><span class="n">IyIy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>
<span class="w">      </span><span class="n">IyIt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span><span class="w"> </span><span class="n">It</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// A12/A22</span>
<span class="w">      </span><span class="n">IxIy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Weight</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Summate the weights</span>
<span class="w">      </span><span class="n">SumW</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Weight</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// Check if SumW is not 0</span>
<span class="w">   </span><span class="n">SumW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SumW</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Normalized weighted variables</span>
<span class="w">   </span><span class="n">IxIx</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>
<span class="w">   </span><span class="n">IyIy</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>
<span class="w">   </span><span class="n">IxIy</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>
<span class="w">   </span><span class="n">IxIt</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>
<span class="w">   </span><span class="n">IyIt</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">SumW</span><span class="p">;</span>

<span class="w">   </span><span class="cm">/*</span>
<span class="cm">      Calculate Lucas-Kanade matrix</span>
<span class="cm">      ---</span>
<span class="cm">      [ Ix^2/D -IxIy/D] = [-IxIt]</span>
<span class="cm">      [-IxIy/D  Iy^2/D]   [-IyIt]</span>
<span class="cm">   */</span>

<span class="w">   </span><span class="kt">float2x2</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float2x2</span><span class="p">(</span><span class="n">IxIx</span><span class="p">,</span><span class="w"> </span><span class="n">IxIy</span><span class="p">,</span><span class="w"> </span><span class="n">IxIy</span><span class="p">,</span><span class="w"> </span><span class="n">IyIy</span><span class="p">);</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float2</span><span class="p">(</span><span class="n">IxIt</span><span class="p">,</span><span class="w"> </span><span class="n">IyIt</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// Calculate C factor</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">B</span><span class="p">;</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dot</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">);</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dot</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="nb">mul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">));</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Calculate -C * B</span>
<span class="w">   </span><span class="kt">float2</span><span class="w"> </span><span class="n">Flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Normalize motion vectors</span>
<span class="w">   </span><span class="n">Flow</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">PixelSize</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Propagate normalized motion vectors in Norm Range</span>
<span class="w">   </span><span class="n">Vectors</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Flow</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Clamp motion vectors to restrict range to valid lengths</span>
<span class="w">   </span><span class="n">Vectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">clamp</span><span class="p">(</span><span class="n">Vectors</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">Vectors</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Baker, S., &amp; Matthews, I. (2004). Lucas-kanade 20 years on: A unifying framework. International journal of computer vision, 56, 221-255.</p></li>
<li><p>Rojas, R. (2010). Lucas-kanade in a nutshell. Freie Universit at Berlinn, Dept. of Computer Science, Tech. Rep.</p></li>
<li><p>Titkov, V. V., Panin, S. V., Lyubutin, P. S., Chemezov, V. O., &amp; Eremin, A. V. (2017). Application of Lucas-Kanade algorithm with weight coefficient bilateral filtration for the digital image correlation method. IOP Conference Series: Materials Science and Engineering, 177, 012039. <a class="reference external" href="https://doi.org/10.1088/1757-899X/177/1/012039">https://doi.org/10.1088/1757-899X/177/1/012039</a></p></li>
<li><p>Wikipedia contributors. (2024, May 15). Lucas-Kanade method. In Wikipedia, The Free Encyclopedia. Retrieved 18:46, July 3, 2025, from <a class="reference external" href="https://en.wikipedia.org/w/index.php?title=Lucas%E2%80%93Kanade_method&amp;oldid=1223913530">https://en.wikipedia.org/w/index.php?title=Lucas%E2%80%93Kanade_method&amp;oldid=1223913530</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../learning/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Learning Experiences</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="loops.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">An Alternative 2D Loop on the GPU</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, papadanku
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Lucas-Kanade Optical Flow on the GPU</a><ul>
<li><a class="reference internal" href="#the-brightness-constancy-assumption">The Brightness Constancy Assumption</a></li>
<li><a class="reference internal" href="#the-optical-flow-equation">The Optical Flow Equation</a></li>
<li><a class="reference internal" href="#the-aperture-problem-in-practice">The Aperture Problem - In Practice</a></li>
<li><a class="reference internal" href="#the-aperture-problem-in-mathematics">The Aperture Problem - In Mathematics</a></li>
<li><a class="reference internal" href="#the-lucas-kanade-approach-to-the-aperture-problem">The Lucas-Kanade Approach to The Aperture Problem</a><ul>
<li><a class="reference internal" href="#least-squares-derivation">Least-Squares Derivation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-pyramid-approach">The Pyramid Approach</a></li>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>